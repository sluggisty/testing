---
# configure.yaml - Update snail-core configuration on all VMs
# ===========================================================

- name: Configure snail-core on all VMs
  hosts: snail_vms
  become: true
  
  vars:
    snail_config_path: "/etc/snail-core/config.yaml"
    api_endpoint: "{{ snail_api_endpoint | default('http://192.168.124.1:8080/api/v1/ingest') }}"
    api_key: "{{ snail_api_key | default('test-api-key-12345') }}"
    upload_enabled: "{{ snail_upload_enabled | default(true) }}"
    log_level: "{{ snail_log_level | default('INFO') }}"
    enabled_collectors: "{{ snail_enabled_collectors | default([]) }}"
    disabled_collectors: "{{ snail_disabled_collectors | default([]) }}"
  
  tasks:
    - name: Ensure config directory exists
      ansible.builtin.file:
        path: /etc/snail-core
        state: directory
        mode: '0755'
    
    - name: Create snail-core configuration
      ansible.builtin.copy:
        dest: "{{ snail_config_path }}"
        mode: '0644'
        content: |
          # Snail Core Configuration
          # Generated by Ansible on {{ ansible_date_time.iso8601 }}
          
          upload:
            url: "{{ api_endpoint }}"
            enabled: {{ upload_enabled | lower }}
            timeout: 30
            retries: 3
          
          auth:
            api_key: "{{ api_key }}"
          
          collection:
            enabled_collectors: {{ enabled_collectors | to_json }}
            disabled_collectors: {{ disabled_collectors | to_json }}
            timeout: 300
          
          output:
            dir: /var/lib/snail-core
            keep_local: true
            compress: true
          
          logging:
            level: {{ log_level }}
      notify: Restart snail timer
    
    - name: Update environment file
      ansible.builtin.lineinfile:
        path: /etc/profile.d/snail.sh
        regexp: '^export SNAIL_API_KEY='
        line: 'export SNAIL_API_KEY="{{ api_key }}"'
        create: true
        mode: '0644'
  
  handlers:
    - name: Restart snail timer
      ansible.builtin.systemd:
        name: snail-core.timer
        state: restarted
        daemon_reload: true

